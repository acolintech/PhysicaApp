<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysicaApp: Ecosistema de Aprendizaje Interactivo - Para ZoZo, mi hermosa hija talentosa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .domain-map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .node {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .node:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .node-completed {
            background-color: #d1fae5;
            border-color: #10b981;
            border-width: 2px;
        }
        .xp-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        iframe {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
                <h1 class="text-3xl font-bold text-blue-600">Physica<span class="text-gray-700">App -  Para: ZoZo, ¬°mi hermosa hija talentosa!, en su camino al sue√±o de Jap√≥n </br> ¬°Los sue√±os se cumplen!</span></h1>
                <div id="user-profile" class="flex items-center space-x-4 bg-white p-2 rounded-full shadow-sm">
                    <div class="text-right">
                        <p class="font-semibold text-sm" id="user-level">Aprendiz Newtoniano</p>
                        <div class="w-24 bg-gray-200 rounded-full h-2.5 mt-1">
                            <div id="xp-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 10%"></div>
                        </div>
                        <p class="text-xs text-gray-500"><span id="user-xp">10</span>/100 XP</p>
                    </div>
                    <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=üßë‚Äçüî¨" alt="User Avatar" class="w-10 h-10 rounded-full">
                </div>
            </header>

            <!-- Domain Map View -->
            <main id="domain-map-view">
                <h2 class="text-2xl font-semibold mb-2">Mapa de Dominio</h2>
                <p class="text-gray-600 mb-6">Explora el universo de la f√≠sica. Completa un tema para iluminarlo y ganar XP.</p>

                <div class="domain-map-grid">
                    <!-- Unit 1 -->
                    <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="mechanics" data-title="Fundamentos de la Mec√°nica">
                        <h3 class="font-bold text-lg mb-2">Unidad 1: Fundamentos de la Mec√°nica</h3>
                        <p class="text-sm text-gray-600">Fuerzas, movimiento y energ√≠a que gobiernan nuestro mundo.</p>
                    </div>
                    <!-- Unit 2 -->
                    <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="rotation" data-title="Movimiento Rotacional y Gravitaci√≥n">
                        <h3 class="font-bold text-lg mb-2">Unidad 2: Movimiento Rotacional</h3>
                        <p class="text-sm text-gray-600">El giro de los planetas y las ruedas.</p>
                    </div>
                    <!-- Unit 3 -->
                    <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="waves" data-title="Ondas y Sonido">
                        <h3 class="font-bold text-lg mb-2">Unidad 3: Ondas y Sonido</h3>
                        <p class="text-sm text-gray-600">Las vibraciones que nos permiten ver y escuchar.</p>
                    </div>
                    <!-- Unit 4 -->
                    <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="thermo" data-title="Termodin√°mica">
                        <h3 class="font-bold text-lg mb-2">Unidad 4: Termodin√°mica</h3>
                        <p class="text-sm text-gray-600">El estudio del calor, la energ√≠a y el desorden.</p>
                    </div>
                    <!-- Unit 5 -->
                     <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="electrostatics" data-title="Electrost√°tica y Circuitos CD">
                        <h3 class="font-bold text-lg mb-2">Unidad 5: Electrost√°tica y Circuitos</h3>
                        <p class="text-sm text-gray-600">Cargas, campos el√©ctricos y circuitos b√°sicos.</p>
                    </div>
                    <!-- Unit 6 -->
                     <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="magnetism" data-title="Magnetismo e Inducci√≥n">
                        <h3 class="font-bold text-lg mb-2">Unidad 6: Magnetismo e Inducci√≥n</h3>
                        <p class="text-sm text-gray-600">Fuerzas magn√©ticas, inducci√≥n y corriente alterna.</p>
                    </div>
                    <!-- Unit 7 -->
                     <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="optics" data-title="√ìptica">
                        <h3 class="font-bold text-lg mb-2">Unidad 7: √ìptica</h3>
                        <p class="text-sm text-gray-600">La naturaleza de la luz, reflexi√≥n y refracci√≥n.</p>
                    </div>
                     <div class="node bg-white p-6 rounded-lg shadow-md border-2 border-transparent" data-unit="" data-title="By">
                        <h3 class="font-bold text-lg mb-2">Hecho en M√©xico por:</h3>
                        <p class="text-sm text-gray-600">Acolintech</p>
                    </div>
                </div>
            </main>

            <!-- AEA Module View (Hidden by default) -->
            <section id="aea-module-view" class="hidden">
                <button id="back-to-map" class="mb-6 bg-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 transition">‚Üê Volver al Mapa</button>
                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <div class="p-6 sm:p-8">
                        <h2 id="aea-title" class="text-3xl font-bold mb-2"></h2>
                        <p class="text-gray-600">Completa las tres fases para dominar este concepto.</p>
                    </div>
                    <!-- AEA Tabs -->
                    <div class="border-b border-gray-200 px-6 sm:px-8">
                        <nav class="-mb-px flex space-x-6 overflow-x-auto">
                            <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-gray-300 transition whitespace-nowrap active" data-tab="learn">1. Aprender</button>
                            <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-gray-300 transition whitespace-nowrap" data-tab="explore">2. Explorar</button>
                            <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-gray-300 transition whitespace-nowrap" data-tab="apply">3. Aplicar</button>
                        </nav>
                    </div>

                    <!-- AEA Content -->
                    <div class="p-6 sm:p-8">
                        <!-- Learn Content -->
                        <div id="learn-content" class="tab-content space-y-4"></div>
                        <!-- Explore Content -->
                        <div id="explore-content" class="tab-content hidden"></div>
                        <!-- Apply Content -->
                        <div id="apply-content" class="tab-content hidden"></div>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Modal for "Eureka!" point -->
    <div id="eureka-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 text-center max-w-sm mx-auto transform transition-all scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-yellow-500 mb-4">¬°EUREKA!</h3>
            <p class="text-gray-700 mb-6">¬°Has dominado completamente la unidad y ganado un Punto Eureka por tu excelente desempe√±o!</p>
            <button id="close-modal" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition">Genial</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Content Database ---
            const contentDB = {
                mechanics: {
                    learn: `
                        <h3 class="text-2xl font-semibold">Microlecci√≥n: Leyes de Newton</h3>
                        <p>La primera ley de Newton, o ley de la inercia, establece que un objeto permanecer√° en reposo o en movimiento rectil√≠neo uniforme a menos que una fuerza externa neta act√∫e sobre √©l.</p>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold">F√≥rmula Clave: Segunda Ley de Newton</p>
                            <p>La aceleraci√≥n de un objeto es directamente proporcional a la fuerza neta que act√∫a sobre √©l e inversamente proporcional a su masa.</p>
                            <div class="formula text-xl mt-2" data-formula="F_{neta} = m \\cdot a"></div>
                        </div>
                        <p>Esta relaci√≥n es fundamental para entender c√≥mo las fuerzas causan cambios en el movimiento. Un diagrama de cuerpo libre es una herramienta esencial para visualizar todas las fuerzas que act√∫an sobre un objeto.</p>
                    `,
                    explore: `
                        <h3 class="text-2xl font-semibold mb-4">Simulaci√≥n: Fuerzas y Movimiento</h3>
                        <p class="mb-4">Manipula las variables para construir tu intuici√≥n f√≠sica. ¬øQu√© pasa si duplicas la fuerza?</p>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden border">
                            <iframe src="https://phet.colorado.edu/sims/html/forces-and-motion-basics/latest/forces-and-motion-basics_es.html" allowfullscreen></iframe>
                        </div>
                    `,
                    apply: [
                        { q: "Si empujas una caja con una fuerza de 20 N y esta se acelera a 2 m/s¬≤, ¬øcu√°l es su masa?", o: ["5 kg", "40 kg", "10 kg"], a: "c" },
                        { q: "¬øQu√© principio establece que 'para cada acci√≥n, hay una reacci√≥n igual y opuesta'?", o: ["Tercera Ley de Newton", "Ley de la Inercia", "Ley de la Gravitaci√≥n Universal"], a: "a" }
                    ]
                },
                rotation: {
                    learn: `
                        <h3 class="text-2xl font-semibold">Microlecci√≥n: Torque y Momento Angular</h3>
                        <p>El torque es el an√°logo rotacional de la fuerza. Es una medida de cu√°n eficazmente una fuerza causa un cambio en el movimiento rotacional de un objeto.</p>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold">F√≥rmula Clave: Torque</p>
                            <p>El torque es el producto de la fuerza por el brazo de palanca (la distancia perpendicular desde el eje de rotaci√≥n a la l√≠nea de acci√≥n de la fuerza).</p>
                            <div class="formula text-xl mt-2" data-formula="\\tau = r \\times F"></div>
                        </div>
                        <p>El momento angular es una medida de la cantidad de rotaci√≥n de un objeto y se conserva si el torque neto externo es cero.</p>
                    `,
                    explore: `
                        <h3 class="text-2xl font-semibold mb-4">Simulaci√≥n: Torque</h3>
                        <p class="mb-4">Experimenta c√≥mo diferentes fuerzas y distancias al eje de rotaci√≥n afectan el equilibrio de una balanza.</p>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden border">
                            <iframe src="https://phet.colorado.edu/sims/html/balancing-act/latest/balancing-act_es.html" allowfullscreen></iframe>
                        </div>
                    `,
                    apply: [
                        { q: "Si aplicas una fuerza de 10 N a 0.5 m del eje de rotaci√≥n, ¬øcu√°l es el torque?", o: ["5 N¬∑m", "20 N¬∑m", "2 N¬∑m"], a: "a" },
                        { q: "La conservaci√≥n del momento angular explica por qu√© una patinadora sobre hielo gira m√°s r√°pido cuando...", o: ["extiende sus brazos", "recoge sus brazos", "salta"], a: "b" }
                    ]
                },
                waves: {
                    learn: `
                        <h3 class="text-2xl font-semibold">Microlecci√≥n: Ondas y Sonido</h3>
                        <p>Una onda es una perturbaci√≥n que transfiere energ√≠a a trav√©s del espacio o un medio. Las propiedades clave incluyen amplitud, longitud de onda, frecuencia y per√≠odo.</p>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold">F√≥rmula Clave: Velocidad de la Onda</p>
                            <p>La velocidad de una onda es el producto de su frecuencia y su longitud de onda.</p>
                            <div class="formula text-xl mt-2" data-formula="v = f \\cdot \\lambda"></div>
                        </div>
                        <p>El sonido es una onda mec√°nica longitudinal que se propaga a trav√©s de un medio como el aire.</p>
                    `,
                    explore: `
                        <h3 class="text-2xl font-semibold mb-4">Simulaci√≥n: Onda en una Cuerda</h3>
                        <p class="mb-4">Observa c√≥mo cambiar la frecuencia y la amplitud afecta la forma y el movimiento de una onda.</p>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden border">
                            <iframe src="https://phet.colorado.edu/sims/html/wave-on-a-string/latest/wave-on-a-string_es.html" allowfullscreen></iframe>
                        </div>
                    `,
                    apply: [
                        { q: "Si una onda tiene una frecuencia de 100 Hz y una longitud de onda de 2 m, ¬øcu√°l es su velocidad?", o: ["50 m/s", "200 m/s", "0.02 m/s"], a: "b" },
                        { q: "El efecto Doppler describe el cambio en la frecuencia de una onda en relaci√≥n a un observador que se mueve. Si una ambulancia se acerca, el sonido parece...", o: ["m√°s grave", "igual", "m√°s agudo"], a: "c" }
                    ]
                },
                thermo: {
                    learn: `
                        <h3 class="text-2xl font-semibold">Microlecci√≥n: Leyes de la Termodin√°mica</h3>
                        <p>La termodin√°mica es el estudio del calor, el trabajo y la energ√≠a. La Primera Ley es una declaraci√≥n de la conservaci√≥n de la energ√≠a.</p>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold">F√≥rmula Clave: Primera Ley</p>
                            <p>El cambio en la energ√≠a interna de un sistema es igual al calor a√±adido al sistema menos el trabajo realizado por el sistema.</p>
                            <div class="formula text-xl mt-2" data-formula="\\Delta U = Q - W"></div>
                        </div>
                        <p>La Segunda Ley introduce el concepto de entrop√≠a y establece que el desorden total de un sistema aislado siempre tiende a aumentar con el tiempo.</p>
                    `,
                    explore: `
                        <h3 class="text-2xl font-semibold mb-4">Simulaci√≥n: Propiedades de los Gases</h3>
                        <p class="mb-4">Bombea mol√©culas de gas en una caja y ve qu√© sucede a medida que cambias el volumen, la temperatura y la presi√≥n.</p>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden border">
                            <iframe src="https://phet.colorado.edu/sims/html/gas-properties/latest/gas-properties_es.html" allowfullscreen></iframe>
                        </div>
                    `,
                    apply: [
                        { q: "El punto de ebullici√≥n del agua en la escala Kelvin es:", o: ["100 K", "273.15 K", "373.15 K"], a: "c" },
                        { q: "Un proceso en el que no hay transferencia de calor se llama:", o: ["Isot√©rmico", "Isob√°rico", "Adiab√°tico"], a: "c" }
                    ]
                },
                electrostatics: {
                    learn: `
                        <h3 class="text-2xl font-semibold">Microlecci√≥n: Ley de Ohm y Circuitos</h3>
                        <p>La electrost√°tica estudia las cargas el√©ctricas en reposo. La Ley de Coulomb describe la fuerza entre dos cargas.</p>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold">F√≥rmula Clave: Ley de Ohm</p>
                            <p>El voltaje a trav√©s de un resistor es directamente proporcional a la corriente que fluye a trav√©s de √©l.</p>
                            <div class="formula text-xl mt-2" data-formula="V = I \\cdot R"></div>
                        </div>
                        <p>En los circuitos de corriente directa (CD), los componentes como resistores se pueden conectar en serie o en paralelo, siguiendo las Leyes de Kirchhoff.</p>
                    `,
                    explore: `
                        <h3 class="text-2xl font-semibold mb-4">Simulaci√≥n: Kit de Construcci√≥n de Circuitos CD</h3>
                        <p class="mb-4">¬°Construye tus propios circuitos! Conecta bater√≠as, bombillas, resistores e interruptores para ver c√≥mo fluye la electricidad.</p>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden border">
                            <iframe src="https://phet.colorado.edu/sims/html/circuit-construction-kit-dc-virtual-lab/latest/circuit-construction-kit-dc-virtual-lab_es.html" allowfullscreen></iframe>
                        </div>
                    `,
                    apply: [
                        { q: "Si un circuito tiene una bater√≠a de 12 V y un resistor de 4 Œ©, ¬øcu√°l es la corriente?", o: ["3 A", "48 A", "0.33 A"], a: "a" },
                        { q: "En una conexi√≥n en serie, la corriente total...", o: ["se divide entre los componentes", "es la misma a trav√©s de todos los componentes", "es la suma de las corrientes"], a: "b" }
                    ]
                },
                magnetism: {
                    learn: `
                        <h3 class="text-2xl font-semibold">Microlecci√≥n: Magnetismo e Inducci√≥n</h3>
                        <p>El magnetismo es producido por cargas el√©ctricas en movimiento. La Fuerza de Lorentz describe la fuerza sobre una carga que se mueve en un campo magn√©tico.</p>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold">F√≥rmula Clave: Ley de Faraday de la Inducci√≥n</p>
                            <p>Un cambio en el flujo magn√©tico a trav√©s de una espira de alambre induce una fuerza electromotriz (voltaje).</p>
                            <div class="formula text-xl mt-2" data-formula="\\mathcal{E} = -\\frac{d\\Phi_B}{dt}"></div>
                        </div>
                        <p>Este principio es la base de los generadores el√©ctricos, motores y transformadores.</p>
                    `,
                    explore: `
                        <h3 class="text-2xl font-semibold mb-4">Simulaci√≥n: Ley de Faraday</h3>
                        <p class="mb-4">Mueve un im√°n cerca de una bobina para ver c√≥mo se induce una corriente el√©ctrica. ¬øQu√© factores aumentan la corriente?</p>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden border">
                            <iframe src="https://phet.colorado.edu/sims/html/faradays-law/latest/faradays-law_es.html" allowfullscreen></iframe>
                        </div>
                    `,
                    apply: [
                        { q: "La direcci√≥n de la fuerza magn√©tica sobre una carga positiva en movimiento es...", o: ["paralela al campo magn√©tico", "en la direcci√≥n del movimiento", "perpendicular tanto a la velocidad como al campo"], a: "c" },
                        { q: "La Ley de Lenz establece que la corriente inducida fluye en una direcci√≥n que...", o: ["maximiza el cambio de flujo", "se opone al cambio de flujo que la caus√≥", "es aleatoria"], a: "b" }
                    ]
                },
                optics: {
                    learn: `
                        <h3 class="text-2xl font-semibold">Microlecci√≥n: Refracci√≥n y Lentes</h3>
                        <p>La √≥ptica es el estudio de la luz. La refracci√≥n es el cambio de direcci√≥n de la luz cuando pasa de un medio a otro.</p>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold">F√≥rmula Clave: Ley de Snell</p>
                            <p>Relaciona los √°ngulos de incidencia y refracci√≥n con los √≠ndices de refracci√≥n de los dos medios.</p>
                            <div class="formula text-xl mt-2" data-formula="n_1 \\sin(\\theta_1) = n_2 \\sin(\\theta_2)"></div>
                        </div>
                        <p>Las lentes (convergentes y divergentes) utilizan la refracci√≥n para formar im√°genes, lo cual es el principio detr√°s de las gafas, los telescopios y los microscopios.</p>
                    `,
                    explore: `
                        <h3 class="text-2xl font-semibold mb-4">Simulaci√≥n: Refracci√≥n de la Luz</h3>
                        <p class="mb-4">Dispara un l√°ser y observa c√≥mo se desv√≠a al pasar por diferentes materiales como agua o vidrio. ¬°Intenta encontrar el √°ngulo de reflexi√≥n interna total!</p>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden border">
                            <iframe src="https://phet.colorado.edu/sims/html/bending-light/latest/bending-light_es.html" allowfullscreen></iframe>
                        </div>
                    `,
                    apply: [
                        { q: "Cuando la luz pasa del aire al agua, se desv√≠a...", o: ["hacia la normal", "alej√°ndose de la normal", "no se desv√≠a"], a: "a" },
                        { q: "Una lente que es m√°s gruesa en el centro y hace que los rayos de luz paralelos converjan en un punto se llama:", o: ["lente divergente", "espejo plano", "lente convergente"], a: "c" }
                    ]
                }
            };

            // --- State Management ---
            const state = {
                xp: 10,
                level: 'Aprendiz Newtoniano',
                xpToNextLevel: 100,
                completedUnits: [],
                currentUnit: null
            };

            // --- DOM Elements ---
            const domainMapView = document.getElementById('domain-map-view');
            const aeaModuleView = document.getElementById('aea-module-view');
            const backToMapBtn = document.getElementById('back-to-map');
            const nodes = document.querySelectorAll('.node');
            const aeaTitle = document.getElementById('aea-title');
            const tabButtons = document.querySelectorAll('.tab-button');
            const learnContent = document.getElementById('learn-content');
            const exploreContent = document.getElementById('explore-content');
            const applyContent = document.getElementById('apply-content');
            const eurekaModal = document.getElementById('eureka-modal');
            const closeModalBtn = document.getElementById('close-modal');

            // --- UI Update Functions ---
            function updateProfileUI() {
                document.getElementById('user-xp').textContent = state.xp;
                document.getElementById('user-level').textContent = state.level;
                const xpPercentage = (state.xp / state.xpToNextLevel) * 100;
                document.getElementById('xp-bar').style.width = `${xpPercentage}%`;
            }

            function updateDomainMapUI() {
                nodes.forEach(node => {
                    node.classList.toggle('node-completed', state.completedUnits.includes(node.dataset.unit));
                });
            }

            // --- Navigation ---
            function showDomainMap() {
                aeaModuleView.classList.add('hidden');
                domainMapView.classList.remove('hidden');
                state.currentUnit = null;
            }

            function showAEAModule(unit, title) {
                state.currentUnit = unit;
                aeaTitle.textContent = title;
                
                const content = contentDB[unit];
                if (!content) return;

                // Load content dynamically
                learnContent.innerHTML = content.learn;
                exploreContent.innerHTML = content.explore;
                renderQuiz(content.apply);
                
                // Render any LaTeX formulas
                document.querySelectorAll('.formula').forEach(el => {
                    katex.render(el.dataset.formula, el, { throwOnError: false });
                });

                domainMapView.classList.add('hidden');
                aeaModuleView.classList.remove('hidden');
                switchTab('learn');
            }

            // --- AEA Module Logic ---
            function switchTab(targetTab) {
                tabButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.tab === targetTab);
                });
                learnContent.parentElement.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${targetTab}-content`);
                });
            }

            // --- Quiz Logic ---
            function renderQuiz(questions) {
                let quizHTML = `
                    <h3 class="text-2xl font-semibold mb-4">Pr√°ctica: Resuelve los Problemas</h3>
                    <div id="quiz-container" class="space-y-6">
                `;
                questions.forEach((q, index) => {
                    quizHTML += `
                        <div class="quiz-question" data-correct="${q.a}">
                            <p class="font-semibold mb-2">${index + 1}. ${q.q}</p>
                            <div class="space-y-2">
                                ${q.o.map((option, i) => `
                                    <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition cursor-pointer">
                                        <input type="radio" name="q${index}" value="${String.fromCharCode(97 + i)}" class="mr-3"> ${option}
                                    </label>
                                `).join('')}
                            </div>
                            <p class="feedback text-sm mt-2 hidden"></p>
                        </div>
                    `;
                });
                quizHTML += `
                        <button id="submit-quiz" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Evaluar Respuestas</button>
                    </div>
                    <div id="quiz-results" class="hidden mt-6">
                        <h4 class="font-bold">Resultados:</h4>
                        <p id="results-text"></p>
                        <button id="complete-unit" class="hidden mt-4 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">¬°Dominado! Volver al Mapa (+50 XP)</button>
                    </div>
                `;
                applyContent.innerHTML = quizHTML;
                document.getElementById('submit-quiz').addEventListener('click', submitQuiz);
            }

            function submitQuiz() {
                const questions = document.querySelectorAll('.quiz-question');
                let score = 0;
                let allAnswered = true;

                questions.forEach(q => {
                    const selected = q.querySelector('input:checked');
                    const feedbackEl = q.querySelector('.feedback');
                    feedbackEl.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-yellow-600');

                    if (!selected) {
                        feedbackEl.textContent = 'Por favor, selecciona una respuesta.';
                        feedbackEl.classList.add('text-yellow-600');
                        allAnswered = false;
                        return;
                    }

                    if (selected.value === q.dataset.correct) {
                        score++;
                        feedbackEl.textContent = '¬°Correcto!';
                        feedbackEl.classList.add('text-green-600');
                    } else {
                        feedbackEl.textContent = `Incorrecto. La respuesta correcta era la opci√≥n ${q.dataset.correct.toUpperCase()}.`;
                        feedbackEl.classList.add('text-red-600');
                    }
                });
                
                if (!allAnswered) return;

                const quizResults = document.getElementById('quiz-results');
                document.getElementById('results-text').textContent = `Obtuviste ${score} de ${questions.length} respuestas correctas.`;
                quizResults.classList.remove('hidden');
                document.getElementById('submit-quiz').classList.add('hidden');

                const completeUnitBtn = document.getElementById('complete-unit');
                const existingRetryBtn = quizResults.querySelector('.retry-btn');
                if (existingRetryBtn) existingRetryBtn.remove();

                if (score === questions.length) {
                    completeUnitBtn.classList.remove('hidden');
                    completeUnitBtn.onclick = completeCurrentUnit;
                } else {
                    completeUnitBtn.classList.add('hidden');
                    const retryBtn = document.createElement('button');
                    retryBtn.textContent = 'Intentar de Nuevo';
                    retryBtn.className = 'retry-btn mt-4 bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition';
                    retryBtn.onclick = () => renderQuiz(contentDB[state.currentUnit].apply);
                    quizResults.appendChild(retryBtn);
                }
            }
            
            // --- Gamification ---
            function addXP(amount) {
                state.xp += amount;
                if (state.xp >= state.xpToNextLevel) {
                    state.level = 'F√≠sico Intermedio';
                    state.xp -= state.xpToNextLevel;
                    state.xpToNextLevel *= 2;
                }
                updateProfileUI();
            }

            function completeCurrentUnit() {
                if (state.currentUnit && !state.completedUnits.includes(state.currentUnit)) {
                    state.completedUnits.push(state.currentUnit);
                    addXP(50);
                    updateDomainMapUI();
                    showEurekaModal();
                }
                setTimeout(showDomainMap, 500);
            }

            function showEurekaModal() {
                eurekaModal.classList.remove('hidden');
                setTimeout(() => {
                    const modalContent = eurekaModal.querySelector('div');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function hideEurekaModal() {
                 const modalContent = eurekaModal.querySelector('div');
                 modalContent.classList.add('scale-95', 'opacity-0');
                 setTimeout(() => {
                    eurekaModal.classList.add('hidden');
                 }, 300);
            }

            // --- Event Listeners ---
            nodes.forEach(node => {
                node.addEventListener('click', () => showAEAModule(node.dataset.unit, node.dataset.title));
            });

            backToMapBtn.addEventListener('click', showDomainMap);

            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            
            closeModalBtn.addEventListener('click', hideEurekaModal);
            eurekaModal.addEventListener('click', (e) => {
                if(e.target === eurekaModal) hideEurekaModal();
            });

            // --- Initial Render ---
            updateProfileUI();
            updateDomainMapUI();
        });
    </script>
</body>
</html>
